<!DOCTYPE html>
<html>
<head>
    <title>Debug Frontend</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .error { background: #ffe6e6; color: #d00; }
        .success { background: #e6ffe6; color: #060; }
        .info { background: #e6f3ff; color: #006; }
    </style>
</head>
<body>
    <h1>Frontend Debug Tool</h1>
    <button onclick="testLogin()">Test Login</button>
    <button onclick="testWebSocket()">Test WebSocket</button>
    <button onclick="testClientList()">Test Client List</button>
    <button onclick="clearLogs()">Clear Logs</button>
    
    <div id="logs"></div>
    
    <script>
        let accessToken = null;
        let ws = null;
        
        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            logsDiv.appendChild(logDiv);
            console.log(message);
        }
        
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }
        
        async function testLogin() {
            try {
                log('Testing login...', 'info');
                const response = await fetch('https://loopjs-backend-361659024403.us-central1.run.app/api/login', {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: 'admin',
                        password: 'admin123'
                    })
                });
                
                const data = await response.json();
                log('Login response: ' + JSON.stringify(data), 'success');
                
                if (data.accessToken) {
                    accessToken = data.accessToken;
                    localStorage.setItem('accessToken', accessToken);
                    localStorage.setItem('isAuthenticated', 'true');
                    log('Token stored in localStorage', 'success');
                } else {
                    log('No access token received', 'error');
                }
            } catch (error) {
                log('Login error: ' + error.message, 'error');
            }
        }
        
        function testWebSocket() {
            if (!accessToken) {
                log('No access token available. Please login first.', 'error');
                return;
            }
            
            log('Connecting to WebSocket...', 'info');
            ws = new WebSocket('wss://loopjs-backend-361659024403.us-central1.run.app/ws');
            
            ws.onopen = function() {
                log('WebSocket connected', 'success');
                // Send auth message
                const authMessage = {
                    type: 'auth',
                    token: accessToken
                };
                log('Sending auth message: ' + JSON.stringify(authMessage), 'info');
                ws.send(JSON.stringify(authMessage));
            };
            
            ws.onmessage = function(event) {
                log('WebSocket message received: ' + event.data, 'info');
                const data = JSON.parse(event.data);
                
                if (data.type === 'auth_success') {
                    log('Authentication successful!', 'success');
                    // Send web_client identification
                    const webClientMessage = { type: 'web_client' };
                    log('Sending web_client message: ' + JSON.stringify(webClientMessage), 'info');
                    ws.send(JSON.stringify(webClientMessage));
                } else if (data.type === 'client_list_update') {
                    log('Client list update received: ' + data.clients.length + ' clients', 'success');
                    data.clients.forEach(client => {
                        log(`Client: ${client.computerName} (${client.uuid.substring(0, 8)}...) - Status: ${client.status}`, 'info');
                    });
                } else if (data.type === 'web_client_ack') {
                    log('Web client acknowledged by server', 'success');
                }
            };
            
            ws.onerror = function(error) {
                log('WebSocket error: ' + error, 'error');
            };
            
            ws.onclose = function(event) {
                log('WebSocket closed: ' + event.code + ' - ' + event.reason, 'error');
            };
        }
        
        async function testClientList() {
            if (!accessToken) {
                log('No access token available. Please login first.', 'error');
                return;
            }
            
            try {
                log('Testing client list API...', 'info');
                const response = await fetch('https://loopjs-backend-361659024403.us-central1.run.app/api/info/get-user-list', {
                    mode: 'cors',
                    headers: {
                        'Authorization': 'Bearer ' + accessToken
                    }
                });
                
                const data = await response.json();
                log('Client list response: ' + JSON.stringify(data), 'success');
                
                if (data.data) {
                    const onlineClients = data.data.filter(client => client.status === 'online');
                    log(`Found ${data.data.length} total clients, ${onlineClients.length} online`, 'success');
                    
                    onlineClients.forEach(client => {
                        log(`Online client: ${client.computerName} (${client.uuid.substring(0, 8)}...) - IP: ${client.ipAddress}`, 'info');
                    });
                }
            } catch (error) {
                log('Client list error: ' + error.message, 'error');
            }
        }
        
        // Auto-test on load
        window.onload = function() {
            log('Debug tool loaded. Click buttons to test.', 'info');
        };
    </script>
</body>
</html>
