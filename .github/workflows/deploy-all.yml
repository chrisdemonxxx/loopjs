name: Deploy All Services

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PROJECT_ID: code-assist-470813
  REGION: us-central1

jobs:
  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    outputs:
      backend_url: ${{ steps.url.outputs.url }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Deploy Backend to Cloud Run
        run: |
          gcloud run deploy loopjs-backend \
            --source ./backend \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --set-secrets="MONGODB_URI=MONGODB_URI:latest,JWT_SECRET=JWT_SECRET:latest,SESSION_SECRET=SESSION_SECRET:latest" \
            --memory 512Mi \
            --cpu 1 \
            --max-instances 10 \
            --timeout 300

      - name: Get Backend URL
        id: url
        run: |
          URL=$(gcloud run services describe loopjs-backend \
            --region ${{ env.REGION }} \
            --format='value(status.url)')
          echo "Backend deployed to: $URL"
          echo "url=$URL" >> $GITHUB_OUTPUT

      - name: Test Backend Health
        run: |
          sleep 15
          curl -f ${{ steps.url.outputs.url }}/health || exit 1
          echo "âœ… Backend health check passed!"

  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: deploy-backend
    outputs:
      frontend_url: ${{ steps.url.outputs.url }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Deploy Frontend to Cloud Run
        run: |
          gcloud run deploy loopjs-frontend \
            --source ./frontend \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --memory 512Mi \
            --cpu 1 \
            --max-instances 10 \
            --timeout 300 \
            --port 80

      - name: Get Frontend URL
        id: url
        run: |
          URL=$(gcloud run services describe loopjs-frontend \
            --region ${{ env.REGION }} \
            --format='value(status.url)')
          echo "Frontend deployed to: $URL"
          echo "url=$URL" >> $GITHUB_OUTPUT

      - name: Test Frontend
        run: |
          sleep 15
          curl -f ${{ steps.url.outputs.url }} || exit 1
          echo "âœ… Frontend is responding!"

      - name: Deployment Summary
        run: |
          echo "ğŸš€ Deployment Complete!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Backend URL:  ${{ needs.deploy-backend.outputs.backend_url }}"
          echo "Frontend URL: ${{ steps.url.outputs.url }}"
          echo ""
          echo "Public URLs:"
          echo "ğŸŒ Frontend:  https://loopjs.vidai.sbs/"
          echo "ğŸ”§ Backend:   https://loopjs-backend-361659024403.us-central1.run.app/"
          echo "ğŸ”Œ WebSocket: wss://loopjs-backend-361659024403.us-central1.run.app/ws"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
