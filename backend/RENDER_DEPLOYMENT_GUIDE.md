# Render Deployment Guide for LoopJS Backend

## Overview
This guide walks you through deploying the LoopJS backend to Render.com using the included `render.yaml` configuration.

## Prerequisites
- A [Render.com](https://render.com) account
- A MongoDB Atlas database (or other MongoDB hosting)
- Your GitHub repository connected to Render
- Frontend deployment URL (e.g., Vercel)

## Deployment Steps

### 1. Connect Your Repository to Render

1. Log in to [Render Dashboard](https://dashboard.render.com)
2. Click "New +" and select "Web Service"
3. Connect your GitHub repository
4. Select the repository containing your LoopJS backend

### 2. Configure the Service

Render will automatically detect the `render.yaml` file in your backend directory. The configuration includes:

- **Service Name**: `loopjs-backend`
- **Runtime**: Node.js
- **Region**: Oregon (Free tier)
- **Build Command**: `npm ci --production=false`
- **Start Command**: `npm start`
- **Health Check**: `/health` endpoint

### 3. Set Required Environment Variables

Navigate to the "Environment" tab in your Render service and set the following variables:

#### Required Variables

| Variable | Value | Notes |
|----------|-------|-------|
| `MONGODB_URI` | Your MongoDB connection string | Format: `mongodb+srv://<user>:<pass>@<cluster>.mongodb.net/<db>?retryWrites=true&w=majority` |
| `ALLOWED_ORIGINS` | Your frontend URL(s) | Comma-separated. Example: `https://your-app.vercel.app,https://your-domain.com` |

#### Auto-Generated Variables (by Render)
These are automatically generated when using `render.yaml`:
- `JWT_SECRET` - Auto-generated secure secret
- `SESSION_SECRET` - Auto-generated secure secret

#### Pre-configured Variables
These are already set in `render.yaml`:
- `NODE_ENV=production`
- `PORT=10000`
- `JWT_ACCESS_TOKEN_EXPIRATION=15m`
- `JWT_REFRESH_TOKEN_EXPIRATION=24h`
- `LOG_LEVEL=info`
- `RATE_LIMIT_WINDOW_MS=900000`
- `RATE_LIMIT_MAX_REQUESTS=100`
- `WS_HEARTBEAT_INTERVAL=30000`
- `WS_CONNECTION_TIMEOUT=60000`

#### Optional Variables (if using external services)

| Variable | Purpose | Required |
|----------|---------|----------|
| `OPENAI_API_KEY` | OpenAI API integration | If using OpenAI features |
| `GOOGLE_GEMINI_API_KEY` | Google Gemini AI | If using Gemini features |
| `HUGGINGFACE_API_KEY` | HuggingFace models | If using HuggingFace features |

### 4. MongoDB Setup

1. Create a MongoDB Atlas cluster at [cloud.mongodb.com](https://cloud.mongodb.com)
2. Create a database user with read/write permissions
3. Whitelist Render's IP addresses (or use `0.0.0.0/0` for all IPs)
4. Get your connection string from Atlas
5. Add the connection string to Render's `MONGODB_URI` environment variable

**Connection String Format:**
```
mongodb+srv://<username>:<password>@<cluster>.mongodb.net/<database>?retryWrites=true&w=majority&appName=<appname>
```

### 5. Update Frontend CORS

After deployment, update your frontend to use the new backend URL:

1. Get your Render service URL (e.g., `https://loopjs-backend.onrender.com`)
2. Update your frontend's API base URL to point to this
3. Verify CORS is working by testing API calls

### 6. Deploy

1. Click "Create Web Service" in Render
2. Wait for the build to complete
3. Monitor the logs for any errors
4. Access your health check endpoint: `https://your-service.onrender.com/health`

## Production Features

### Database Connection with Retry Logic
The backend now includes robust database connection handling:
- **5 retry attempts** with exponential backoff
- **30-second timeouts** for connection attempts
- **Auto-reconnection** on disconnection
- **Graceful degradation** if MongoDB is unavailable

### Health Check Endpoint
The `/health` endpoint provides:
- Server status
- Uptime information
- Initialization state
- Timestamp

Example response:
```json
{
  "status": "healthy",
  "timestamp": "2025-11-13T10:30:00.000Z",
  "uptime": 3600.5,
  "port": 10000,
  "initialized": true
}
```

### Error Handling
- Comprehensive error logging
- CORS headers on error responses
- Development vs. production error details
- Non-blocking initialization

### Security Features
- Helmet.js for security headers
- Rate limiting (configurable)
- JWT authentication
- Session management
- CORS protection

## Environment Variables Reference

### Complete List of Environment Variables

```env
# Core Configuration
NODE_ENV=production
PORT=10000

# Database
MONGODB_URI=<your-mongodb-connection-string>
MONGO_URI=<your-mongodb-connection-string>  # Backward compatibility

# Security (Auto-generated by Render)
JWT_SECRET=<auto-generated>
SESSION_SECRET=<auto-generated>
JWT_ACCESS_TOKEN_EXPIRATION=15m
JWT_REFRESH_TOKEN_EXPIRATION=24h

# CORS
ALLOWED_ORIGINS=<your-frontend-urls>

# Logging
LOG_LEVEL=info

# Rate Limiting
RATE_LIMIT_WINDOW_MS=900000
RATE_LIMIT_MAX_REQUESTS=100

# WebSocket
WS_HEARTBEAT_INTERVAL=30000
WS_CONNECTION_TIMEOUT=60000

# Optional: External APIs
OPENAI_API_KEY=<your-key>
GOOGLE_GEMINI_API_KEY=<your-key>
HUGGINGFACE_API_KEY=<your-key>
```

## Troubleshooting

### Build Failures
- Check that all dependencies are in `package.json`
- Verify `npm ci` can run successfully locally
- Check Render build logs for specific errors

### Connection Issues
- Verify MongoDB connection string is correct
- Check MongoDB Atlas IP whitelist
- Ensure database user has proper permissions
- Review Render service logs

### CORS Errors
- Verify `ALLOWED_ORIGINS` includes your frontend URL
- Check that frontend is using correct backend URL
- Ensure CORS middleware is properly configured

### Database Connection Failures
- Check MongoDB Atlas is accessible
- Verify connection string format
- Look for retry attempts in logs
- Ensure MongoDB cluster is running

### Performance Issues
- Monitor Render's free tier limitations
- Check database query performance
- Review rate limiting settings
- Consider upgrading Render plan if needed

## Monitoring

### Render Dashboard
- View real-time logs
- Monitor CPU and memory usage
- Check request metrics
- Set up alerts

### Health Checks
Regular health check endpoint monitoring:
```bash
curl https://your-service.onrender.com/health
```

### Database Monitoring
- MongoDB Atlas dashboard
- Connection pool metrics
- Query performance

## Updating the Deployment

### Automatic Deploys
With `autoDeploy: true` in `render.yaml`, pushes to your main branch will automatically deploy.

### Manual Deploys
1. Go to Render Dashboard
2. Select your service
3. Click "Manual Deploy" → "Deploy latest commit"

### Rolling Back
1. Go to "Events" tab in Render Dashboard
2. Find the previous successful deployment
3. Click "Rollback" to restore

## Security Best Practices

1. **Never commit real credentials** to the repository
2. **Use Render's secret management** for sensitive data
3. **Regularly rotate secrets** (JWT_SECRET, SESSION_SECRET)
4. **Keep dependencies updated** with `npm audit`
5. **Monitor security advisories** for packages
6. **Use HTTPS only** in production
7. **Implement rate limiting** to prevent abuse
8. **Review CORS settings** regularly

## Cost Considerations

### Render Free Tier
- 750 hours/month of runtime
- Spins down after 15 minutes of inactivity
- Cold start delay on first request

### MongoDB Atlas Free Tier
- 512 MB storage
- Shared cluster
- Limited to 500 connections

### Scaling Up
When your app grows:
- Upgrade to Render's paid plans for always-on service
- Consider MongoDB Atlas dedicated clusters
- Implement caching (Redis) for better performance

## Support and Resources

- [Render Documentation](https://render.com/docs)
- [MongoDB Atlas Documentation](https://docs.atlas.mongodb.com/)
- [Node.js Best Practices](https://github.com/goldbergyoni/nodebestpractices)
- [Express Security](https://expressjs.com/en/advanced/best-practice-security.html)

## Quick Reference Commands

```bash
# Local testing with production env
NODE_ENV=production npm start

# Check dependencies
npm audit

# Update dependencies
npm update

# Test health endpoint locally
curl http://localhost:8080/health

# View production logs (via Render CLI)
render logs -s loopjs-backend

# Connect to production MongoDB
mongo "mongodb+srv://your-connection-string"
```

## Next Steps After Deployment

1. ✅ Test all API endpoints
2. ✅ Verify WebSocket connections
3. ✅ Check database operations
4. ✅ Monitor initial traffic
5. ✅ Set up error tracking (e.g., Sentry)
6. ✅ Configure custom domain (if needed)
7. ✅ Set up SSL certificate (auto with Render)
8. ✅ Enable monitoring and alerts
9. ✅ Document API endpoints
10. ✅ Create backup strategy

---

**Deployment Checklist:**
- [ ] MongoDB Atlas cluster created
- [ ] Database user created with credentials
- [ ] IP whitelist configured
- [ ] Render account created
- [ ] Repository connected to Render
- [ ] Environment variables set in Render
- [ ] Frontend updated with backend URL
- [ ] Health check tested
- [ ] CORS verified
- [ ] WebSocket connections tested
- [ ] Production monitoring enabled
